<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تشخيص الصفحة البيضاء - لوحة التحكم</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error-log {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success-log {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .iframe-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
            background: white;
            position: relative;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 6px;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { color: #f14c4c; }
        .warning { color: #ffcc02; }
        .info { color: #3794ff; }
        .success { color: #73c991; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 تشخيص الصفحة البيضاء - لوحة التحكم</h1>
        
        <div class="success-log">
            <h3>📋 معلومات التشخيص:</h3>
            <div id="diagnosis-info">جاري التحليل...</div>
        </div>

        <div>
            <button class="btn" onclick="checkNetworkRequests()">🌐 فحص طلبات الشبكة</button>
            <button class="btn" onclick="checkConsoleErrors()">🐛 فحص أخطاء Console</button>
            <button class="btn" onclick="testDirectAccess()">🔗 اختبار الوصول المباشر</button>
            <button class="btn" onclick="loadAdminWithDebug()">🔧 تحميل مع التشخيص</button>
            <button class="btn" onclick="clearCache()">🗑️ مسح Cache</button>
        </div>

        <div class="console-output" id="console-output">
            <div class="info">🚀 بدء تشخيص الصفحة البيضاء...</div>
        </div>

        <div class="iframe-container" id="iframe-container" style="display: none;">
            <h3>📱 لوحة التحكم مُحمّلة مع التشخيص:</h3>
            <iframe id="admin-iframe" src=""></iframe>
            <div id="iframe-errors" class="error-log" style="display: none;"></div>
        </div>

        <div id="network-analysis" class="error-log" style="display: none;">
            <h4>🌐 تحليل طلبات الشبكة:</h4>
            <div id="network-details"></div>
        </div>
    </div>

    <script>
        const output = document.getElementById('console-output');
        const diagnosisInfo = document.getElementById('diagnosis-info');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function updateDiagnosis(info) {
            diagnosisInfo.innerHTML = info;
        }

        // فحص الحالة الأولية
        window.onload = function() {
            log('🔍 بدء تشخيص شامل للصفحة البيضاء', 'info');
            
            updateDiagnosis(`
                التاريخ: ${new Date().toLocaleString('ar-SA')}
                المتصفح: ${navigator.userAgent.split(' ').pop()}
                الشاشة: ${screen.width}x${screen.height}
                JavaScript: مُفعّل ✅
            `);

            // اختبار تلقائي للخوادم
            setTimeout(checkServers, 1000);
        };

        async function checkServers() {
            log('🖥️ فحص حالة الخوادم...', 'info');
            
            try {
                // فحص الخادم الأمامي
                const frontendResponse = await fetch('http://localhost:5177/');
                if (frontendResponse.ok) {
                    log('✅ الخادم الأمامي يعمل (Port 5177)', 'success');
                } else {
                    log(`❌ مشكلة في الخادم الأمامي: ${frontendResponse.status}`, 'error');
                }

                // فحص الخادم الخلفي
                const backendResponse = await fetch('http://localhost:5000/api/health');
                if (backendResponse.ok) {
                    log('✅ الخادم الخلفي يعمل (Port 5000)', 'success');
                } else {
                    log(`❌ مشكلة في الخادم الخلفي: ${backendResponse.status}`, 'error');
                }

                // فحص صفحة الأدمن
                const adminResponse = await fetch('http://localhost:5177/admin');
                if (adminResponse.ok) {
                    const content = await adminResponse.text();
                    if (content.includes('<div id="root">')) {
                        log('✅ صفحة الأدمن قابلة للوصول', 'success');
                        log('🔍 المحتوى يحتوي على React root div', 'info');
                    } else {
                        log('⚠️ صفحة الأدمن لا تحتوي على React root', 'warning');
                    }
                } else {
                    log(`❌ لا يمكن الوصول لصفحة الأدمن: ${adminResponse.status}`, 'error');
                }

            } catch (error) {
                log(`❌ خطأ في فحص الخوادم: ${error.message}`, 'error');
            }
        }

        async function checkNetworkRequests() {
            log('🌐 فحص طلبات الشبكة للصفحة...', 'info');
            document.getElementById('network-analysis').style.display = 'block';
            
            // قائمة الملفات المهمة التي يجب أن تُحمّل
            const criticalFiles = [
                'http://localhost:5177/',
                'http://localhost:5177/src/main.tsx',
                'http://localhost:5177/src/App.tsx',
                'http://localhost:5177/src/pages/admin/AdminPage.tsx'
            ];

            const networkDetails = document.getElementById('network-details');
            networkDetails.innerHTML = '';

            for (const file of criticalFiles) {
                try {
                    const response = await fetch(file);
                    const status = response.ok ? '✅' : '❌';
                    const size = response.headers.get('content-length') || 'غير معروف';
                    networkDetails.innerHTML += `${status} ${file} - ${response.status} (${size} bytes)\n`;
                    
                    if (response.ok) {
                        log(`✅ تم تحميل: ${file}`, 'success');
                    } else {
                        log(`❌ فشل تحميل: ${file} - ${response.status}`, 'error');
                    }
                } catch (error) {
                    networkDetails.innerHTML += `❌ ${file} - خطأ: ${error.message}\n`;
                    log(`❌ خطأ شبكة: ${file} - ${error.message}`, 'error');
                }
            }
        }

        function checkConsoleErrors() {
            log('🐛 فحص أخطاء Console...', 'info');
            
            // إعادة تعريف console.error لالتقاط الأخطاء
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.error = function(...args) {
                log(`🔴 Console Error: ${args.join(' ')}`, 'error');
                originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
                log(`🟡 Console Warning: ${args.join(' ')}`, 'warning');
                originalWarn.apply(console, args);
            };
            
            log('✅ تم تفعيل مراقبة أخطاء Console', 'success');
        }

        async function testDirectAccess() {
            log('🔗 اختبار الوصول المباشر لصفحة الأدمن...', 'info');
            
            try {
                const response = await fetch('http://localhost:5177/admin', {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    log('✅ تم الحصول على HTML للصفحة', 'success');
                    log(`📄 حجم HTML: ${html.length} حرف`, 'info');
                    
                    // فحص محتوى HTML
                    if (html.includes('react')) {
                        log('✅ الصفحة تحتوي على React', 'success');
                    }
                    if (html.includes('vite')) {
                        log('✅ الصفحة تحتوي على Vite', 'success');
                    }
                    if (html.includes('<div id="root">')) {
                        log('✅ الصفحة تحتوي على React root div', 'success');
                    }
                    if (html.includes('main.tsx')) {
                        log('✅ الصفحة تحتوي على main.tsx script', 'success');
                    }
                    
                } else {
                    log(`❌ فشل الحصول على الصفحة: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ خطأ في الوصول المباشر: ${error.message}`, 'error');
            }
        }

        function loadAdminWithDebug() {
            log('🔧 تحميل صفحة الأدمن مع التشخيص...', 'info');
            
            const iframe = document.getElementById('admin-iframe');
            const container = document.getElementById('iframe-container');
            const errorsDiv = document.getElementById('iframe-errors');
            
            container.style.display = 'block';
            iframe.src = 'http://localhost:5177/admin';
            
            iframe.onload = function() {
                log('✅ تم تحميل صفحة الأدمن في iframe', 'success');
                
                // محاولة الوصول لـ console في iframe
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc) {
                        log('✅ يمكن الوصول لمحتوى iframe', 'success');
                        
                        // فحص وجود React root
                        const rootDiv = iframeDoc.getElementById('root');
                        if (rootDiv) {
                            log('✅ تم العثور على React root div', 'success');
                            if (rootDiv.children.length > 0) {
                                log('✅ React root div يحتوي على عناصر', 'success');
                            } else {
                                log('⚠️ React root div فارغ - هنا المشكلة!', 'warning');
                            }
                        } else {
                            log('❌ لم يتم العثور على React root div', 'error');
                        }
                    }
                } catch (error) {
                    log(`⚠️ لا يمكن الوصول لمحتوى iframe: ${error.message}`, 'warning');
                }
            };
            
            iframe.onerror = function(error) {
                log(`❌ خطأ في تحميل iframe: ${error}`, 'error');
                errorsDiv.style.display = 'block';
                errorsDiv.textContent = `خطأ iframe: ${error}`;
            };
        }

        function clearCache() {
            log('🗑️ مسح Cache المتصفح...', 'info');
            
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                    log('✅ تم مسح Service Worker caches', 'success');
                });
            }
            
            // مسح localStorage
            try {
                localStorage.clear();
                log('✅ تم مسح localStorage', 'success');
            } catch (error) {
                log(`⚠️ لا يمكن مسح localStorage: ${error.message}`, 'warning');
            }
            
            // مسح sessionStorage
            try {
                sessionStorage.clear();
                log('✅ تم مسح sessionStorage', 'success');
            } catch (error) {
                log(`⚠️ لا يمكن مسح sessionStorage: ${error.message}`, 'warning');
            }
            
            log('💡 لمسح cache المتصفح بالكامل، اضغط Ctrl+Shift+R', 'info');
        }

        // التقاط الأخطاء العامة
        window.addEventListener('error', function(event) {
            log(`🔴 JavaScript Error: ${event.message} في ${event.filename}:${event.lineno}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            log(`🔴 Unhandled Promise Rejection: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
